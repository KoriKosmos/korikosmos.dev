---
import Layout from '../layouts/Layout.astro';
import { getRecentTracks, getTopArtists, getTopAlbums, getBestImage } from '../lib/lastfm';

const recentTracks = await getRecentTracks(10);
const topArtists = await getTopArtists('overall', 5);
const topAlbums = await getTopAlbums('overall', 5);

const currentTrack = recentTracks[0];
const isPlaying = currentTrack?.['@attr']?.nowplaying === 'true';
---

<Layout title="Tunes | KoriKosmos">
  <div class="space-y-12 animate-fade-in">
    <!-- Hero Section: Now Playing / Most Recent -->
    <section class="relative overflow-hidden rounded-3xl bg-base-200 shadow-xl min-h-[400px] flex items-center justify-center">
        <!-- Background Blur -->
        <div class="absolute inset-0 z-0">
             <img 
                id="hero-bg-img"
                src={getBestImage(currentTrack?.image) || '/placeholder-music.png'} 
                alt="" 
                class="w-full h-full object-cover opacity-30 blur-3xl scale-110"
            />
             <div class="absolute inset-0 bg-base-100/50"></div>
        </div>

        <div class="relative z-10 flex flex-col md:flex-row items-center gap-8 p-8 w-full max-w-4xl mx-auto">
            <div class="relative group">
                 <img 
                    id="hero-fg-img"
                    src={getBestImage(currentTrack?.image) || '/placeholder-music.png'} 
                    alt={currentTrack?.name} 
                    class="w-64 h-64 rounded-2xl shadow-2xl object-cover transition-transform duration-500 group-hover:scale-105"
                />
                <div id="now-playing-badge" class={`absolute -top-4 -right-4 bg-accent text-accent-content text-xs font-bold px-3 py-1 rounded-full shadow-lg animate-bounce ${isPlaying ? '' : 'hidden'}`}>
                    NOW PLAYING
                </div>
            </div>
            
            <div class="text-center md:text-left space-y-4 flex-1">
                <h2 id="hero-status-text" class="text-sm uppercase tracking-widest text-secondary font-semibold">
                    {isPlaying ? 'Currently Vibing To' : 'Last Listened'}
                </h2>
                <h1 id="hero-track-name" class="text-4xl md:text-6xl font-black leading-tight bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">
                    {currentTrack?.name || 'Nothing playing'}
                </h1>
                <p id="hero-artist-name" class="text-xl md:text-2xl text-base-content/80 font-medium">
                    {currentTrack?.artist['#text']}
                </p>
                <div id="hero-album-name" class="text-sm text-base-content/60">
                    {currentTrack?.album['#text']}
                </div>
            </div>
        </div>
    </section>

    <!-- History & Charts Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Recent History (Fixed) -->
        <section class="bg-base-200/50 backdrop-blur-sm p-6 rounded-2xl border border-base-content/5 h-fit">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <span class="text-primary">scrobbles</span>
                <span class="text-base-content/40 text-sm font-normal">History</span>
            </h2>
            <div class="space-y-4" id="recent-list">
                {recentTracks.slice(1, 6).map((track) => (
                    <div class="flex items-center gap-4 group p-2 rounded-xl hover:bg-base-100/50 transition-colors">
                        <img 
                            src={getBestImage(track.image)} 
                            alt={track.name}
                            class="w-12 h-12 rounded-md object-cover shadow-sm group-hover:scale-105 transition-transform"
                        />
                        <div class="min-w-0 flex-1">
                            <h3 class="font-bold truncate group-hover:text-primary transition-colors">{track.name}</h3>
                            <p class="text-sm text-base-content/60 truncate">{track.artist['#text']}</p>
                        </div>
                    </div>
                ))}
            </div>
        </section>

        <!-- Top Charts (Variable) -->
        <div class="space-y-8">
            <!-- Controls -->
            <div class="flex justify-end">
                <div class="flex gap-2 bg-base-100 p-1 rounded-lg border border-base-content/10">
                    <button class="btn btn-sm btn-ghost period-btn active rounded-md" data-period="overall">All Time</button>
                    <button class="btn btn-sm btn-ghost period-btn rounded-md" data-period="12month">Last Year</button>
                    <button class="btn btn-sm btn-ghost period-btn rounded-md" data-period="7day">Last Week</button>
                </div>
            </div>

            <!-- Top Artists -->
            <section class="bg-base-200/50 backdrop-blur-sm p-6 rounded-2xl border border-base-content/5 relative group/section">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <span class="text-secondary">artists</span>
                    <span class="text-base-content/40 text-sm font-normal period-label">All Time</span>
                </h2>
                 <div id="loading-overlay-artists" class="absolute inset-0 bg-base-200/80 items-center justify-center z-10 rounded-2xl hidden">
                    <span class="loading loading-spinner loading-md text-secondary"></span>
                </div>
                <div class="flex flex-wrap gap-2" id="artists-list">
                    {topArtists.map((artist, i) => (
                        <a href={artist.url} target="_blank" rel="noopener noreferrer" 
                           class="flex items-center gap-2 px-3 py-1.5 bg-base-100 rounded-full border border-base-content/5 hover:border-secondary hover:text-secondary transition-all text-sm">
                            <span class="text-secondary font-bold text-xs">#{i + 1}</span>
                            {artist.name}
                        </a>
                    ))}
                </div>
            </section>

            <!-- Top Albums -->
            <section class="bg-base-200/50 backdrop-blur-sm p-6 rounded-2xl border border-base-content/5 relative group/section">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <span class="text-accent">albums</span>
                    <span class="text-base-content/40 text-sm font-normal period-label">All Time</span>
                </h2>
                <div id="loading-overlay-albums" class="absolute inset-0 bg-base-200/80 items-center justify-center z-10 rounded-2xl hidden">
                    <span class="loading loading-spinner loading-md text-accent"></span>
                </div>
                <div class="grid grid-cols-5 gap-2" id="albums-list">
                    {topAlbums.map((album) => (
                        <a href={album.url} target="_blank" rel="noopener noreferrer" class="group relative aspect-square">
                            <img 
                                src={getBestImage(album.image)} 
                                alt={album.name}
                                class="w-full h-full rounded-lg object-cover shadow-md group-hover:shadow-xl group-hover:scale-105 transition-all duration-300"
                                title={`${album.name} by ${album.artist.name}`}
                            />
                        </a>
                    ))}
                </div>
            </section>
        </div>
    </div>
  </div>

  <style>
      .period-btn.active {
          background-color: oklch(var(--p));
          color: oklch(var(--pc));
      }
  </style>

  <script>
    // Note: getBestImage is redefined here to avoid import issues in client-side script

    // If importing is not possible in inline script without bundling config, redefine helper or expose globally.
    // Astro scripts are modules by default so imports work if the path is resolvable.
    // For simplicity/robustness in this inline context:
    function getBestImage(images) {
      if (!Array.isArray(images)) return '';
      const sizes = ['extralarge', 'large', 'medium', 'small'];
      for (const size of sizes) {
        const img = images.find((i) => i.size === size);
        if (img && img['#text']) return img['#text'];
      }
      return images[0]?.['#text'] || '';
    }

    // Toggle Logic
    const buttons = document.querySelectorAll('.period-btn');
    const artistsList = document.getElementById('artists-list');
    const albumsList = document.getElementById('albums-list');
    const periodLabels = document.querySelectorAll('.period-label');
    const loaders = {
        artists: document.getElementById('loading-overlay-artists'),
        albums: document.getElementById('loading-overlay-albums')
    };

    const periodMap = {
        'overall': 'All Time',
        '12month': 'Last Year',
        '7day': 'Last Week'
    };

    buttons.forEach(btn => {
        btn.addEventListener('click', async () => {
             // 1. Update active state
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const period = btn.dataset.period;
            const label = periodMap[period];

            // 2. Update labels
            periodLabels.forEach(el => el.textContent = label);

            // 3. Show loaders
            Object.values(loaders).forEach(el => el.classList.remove('hidden'));
            Object.values(loaders).forEach(el => el.classList.add('flex'));

            try {
                // 4. Fetch data in parallel
                const [artistsRes, albumsRes] = await Promise.all([
                    fetch(`/api/lastfm?method=artists&period=${period}&limit=5`),
                    fetch(`/api/lastfm?method=albums&period=${period}&limit=5`)
                ]);

                const artists = await artistsRes.json();
                const albums = await albumsRes.json();

                // 5. Render Artists
                artistsList.innerHTML = artists.map((artist, i) => `
                    <a href="${artist.url}" target="_blank" rel="noopener noreferrer" 
                       class="flex items-center gap-2 px-3 py-1.5 bg-base-100 rounded-full border border-base-content/5 hover:border-secondary hover:text-secondary transition-all text-sm">
                        <span class="text-secondary font-bold text-xs">#${i + 1}</span>
                        ${artist.name}
                    </a>
                `).join('');

                // 6. Render Albums
                albumsList.innerHTML = albums.map(album => `
                    <a href="${album.url}" target="_blank" rel="noopener noreferrer" class="group relative aspect-square">
                        <img 
                            src="${getBestImage(album.image)}" 
                            alt="${album.name}"
                            class="w-full h-full rounded-lg object-cover shadow-md group-hover:shadow-xl group-hover:scale-105 transition-all duration-300"
                            title="${album.name} by ${album.artist.name}"
                        />
                    </a>
                `).join('');

            } catch (error) {
                console.error("Failed to fetch data", error);
                // Handle error visually if needed
            } finally {
                // 7. Hide loaders
                Object.values(loaders).forEach(el => el.classList.add('hidden'));
                Object.values(loaders).forEach(el => el.classList.remove('flex'));
            }
        });
    });

    // Client-side Polling for Hero Section
    async function updateNowPlaying() {
        try {
            const res = await fetch('/api/lastfm?limit=1');
            const data = await res.json();
            const track = data[0];
            
            if (!track) return;

            // Elements
            const bgImg = document.getElementById('hero-bg-img');
            const fgImg = document.getElementById('hero-fg-img');
            const statusText = document.getElementById('hero-status-text');
            const trackName = document.getElementById('hero-track-name');
            const artistName = document.getElementById('hero-artist-name');
            const albumName = document.getElementById('hero-album-name');
            const badge = document.getElementById('now-playing-badge');

            // Diff check (using track name + artist as key)
            const currentKey = `${trackName.textContent.trim()}-${artistName.textContent.trim()}`;
            const newKey = `${track.name}-${track.artist['#text']}`;

            if (currentKey !== newKey) {
                // Update text
                trackName.textContent = track.name;
                artistName.textContent = track.artist['#text'];
                albumName.textContent = track.album['#text'];
                
                // Update images
                const imgUrl = getBestImage(track.image) || '/placeholder-music.png';
                bgImg.src = imgUrl;
                fgImg.src = imgUrl;
                fgImg.alt = track.name;
                
                // Update status and badge
                const isPlaying = track['@attr']?.nowplaying === 'true';
                statusText.textContent = isPlaying ? 'Currently Vibing To' : 'Last Listened';
                
                if (isPlaying) {
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        } catch (e) {
            console.error('Failed to update now playing', e);
        }
    }
    
    // Poll every 30 seconds
    setInterval(updateNowPlaying, 30000);
  </script>
</Layout>
