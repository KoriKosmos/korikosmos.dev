---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Tetris">
  <h1 class="text-3xl font-bold my-6">Tetris</h1>
  <div class="flex gap-4">
    <canvas id="board" width="300" height="600"></canvas>
    <div class="space-y-4">
      <div>
        <p class="font-bold">Next</p>
        <canvas id="next" width="120" height="120"></canvas>
      </div>
      <div>
        <p class="font-bold">Hold</p>
        <canvas id="hold" width="120" height="120"></canvas>
      </div>
      <div class="space-y-2">
        <p>Score: <span id="score">0</span></p>
        <p>Lines: <span id="lines">0</span></p>
        <p>Level: <span id="level">0</span></p>
        <p>High Score: <span id="highscore">0</span></p>
      </div>
    </div>
  </div>
  <div class="md:hidden mt-4 flex flex-wrap gap-2">
    <button id="btn-left" class="px-4 py-2 bg-gray-700 text-white rounded">◀</button>
    <button id="btn-rotate-ccw" class="px-4 py-2 bg-gray-700 text-white rounded">⟲</button>
    <button id="btn-rotate" class="px-4 py-2 bg-gray-700 text-white rounded">⟳</button>
    <button id="btn-right" class="px-4 py-2 bg-gray-700 text-white rounded">▶</button>
    <button id="btn-drop" class="px-4 py-2 bg-gray-700 text-white rounded">⬇</button>
    <button id="btn-hold" class="px-4 py-2 bg-gray-700 text-white rounded">H</button>
  </div>
  <div class="mt-6">
    <h2 class="font-bold">Leaderboard</h2>
    <ol id="leaderboard" class="list-decimal ml-6"></ol>
  </div>
  <script>
    import { TetrisGame } from '../../lib/tetris.js';

    // UI Elements
    const $score = document.getElementById('score');
    const $lines = document.getElementById('lines');
    const $level = document.getElementById('level');
    const $high = document.getElementById('highscore');
    const $leaderboard = document.getElementById('leaderboard');

    // High Score System
    let username = localStorage.getItem('tetris_username');
    while (!username) {
      username = prompt('Enter a username:')?.trim();
    }
    localStorage.setItem('tetris_username', username);

    let highScore = parseInt(localStorage.getItem('tetris_highscore') || '0', 10);
    $high.textContent = highScore.toString();

    async function syncAndLoadLeaderboard() {
      let serverData = [];
      try {
        const res = await fetch('/api/scores/tetris');
        if (res.ok) {
            serverData = await res.json();
        }
      } catch (e) {
        console.error('Failed to load leaderboard', e);
      }

      // Check if we need to sync local high score
      if (username && highScore > 0) {
        const serverEntry = serverData.find(e => e.name === username);
        if (!serverEntry || serverEntry.score < highScore) {
           console.log('Syncing local high score to server...', highScore);
           try {
             const res = await fetch('/api/scores/tetris', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ name: username, score: highScore })
             });
             if (res.ok) {
                 serverData = await res.json();
             }
           } catch (e) {
               console.error('Failed to sync score', e);
           }
        }
      }
      
      renderLeaderboard(serverData);
    }
    
    /* parse/save local are removed in favor of API */

    function renderLeaderboard(data) {
      // Clear existing leaderboard entries
      while ($leaderboard.firstChild) {
        $leaderboard.removeChild($leaderboard.firstChild);
      }

      // Safely add entries using textContent to avoid XSS
      data.forEach((e) => {
        const li = document.createElement('li');
        li.textContent = `${e.name}: ${e.score}`;
        $leaderboard.appendChild(li);
      });
    }

    syncAndLoadLeaderboard();

    // Poll for leaderboard updates every 15 seconds
    setInterval(syncAndLoadLeaderboard, 15000);

    // Game Instantiation
    const game = new TetrisGame(
      document.getElementById('board'),
      document.getElementById('next'),
      document.getElementById('hold'),
      {
        onScore: (score, lines, level) => {
          $score.textContent = score;
          $lines.textContent = lines;
          $level.textContent = level;
          if (score > highScore) {
            highScore = score;
            localStorage.setItem('tetris_highscore', highScore.toString());
            $high.textContent = highScore.toString();
          }
        },
        onGameOver: async (finalScore) => {
          // Sync score to server (will submit if it's a new high score) and update leaderboard
          await syncAndLoadLeaderboard();
          
          // Use setTimeout to ensure the DOM updates (Leaderboard repaint) before the alert blocks
          setTimeout(() => {
              alert(`Game over, ${username}! Your score: ${finalScore}`);
              game.reset();
              game.start();
          }, 50);
        }
      }
    );

    // Controls
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        game.setHoriz(-1); e.preventDefault();
      } else if (e.key === 'ArrowRight') {
        game.setHoriz(1); e.preventDefault();
      } else if (e.key === 'ArrowDown') {
        game.setDown(true); e.preventDefault();
      } else if (e.key === 'x' || e.key === 'X') {
        game.tryRotate(1); e.preventDefault();
      } else if (e.key === 'z' || e.key === 'Z') {
        game.tryRotate(-1); e.preventDefault();
      } else if (e.code === 'Space') {
        if (!e.repeat) game.hardDrop();
        e.preventDefault();
      } else if (e.key === 'c' || e.key === 'C' || e.key === 'Shift') {
        game.holdPiece(); e.preventDefault();
      }
    });

    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowLeft') {
        if (game.horiz === -1) game.setHoriz(0);
      } else if (e.key === 'ArrowRight') {
        if (game.horiz === 1) game.setHoriz(0);
      } else if (e.key === 'ArrowDown') {
        game.setDown(false);
      }
    });

    // Mobile Controls
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnRotate = document.getElementById('btn-rotate');
    const btnRotateCCW = document.getElementById('btn-rotate-ccw');
    const btnDrop = document.getElementById('btn-drop');
    const btnHold = document.getElementById('btn-hold');

    function bindButton(el, down, up) {
      if (!el) return;
      el.addEventListener('pointerdown', (e) => { e.preventDefault(); down(); });
      el.addEventListener('pointerup', (e) => { e.preventDefault(); if (up) up(); });
      el.addEventListener('pointerleave', () => { if (up) up(); });
    }

    bindButton(btnLeft, () => game.setHoriz(-1), () => { if (game.horiz === -1) game.setHoriz(0); });
    bindButton(btnRight, () => game.setHoriz(1), () => { if (game.horiz === 1) game.setHoriz(0); });
    
    if (btnRotate) btnRotate.addEventListener('pointerdown', (e) => { e.preventDefault(); game.tryRotate(1); });
    if (btnRotateCCW) btnRotateCCW.addEventListener('pointerdown', (e) => { e.preventDefault(); game.tryRotate(-1); });
    if (btnDrop) btnDrop.addEventListener('pointerdown', (e) => { e.preventDefault(); game.hardDrop(); });
    if (btnHold) btnHold.addEventListener('pointerdown', (e) => { e.preventDefault(); game.holdPiece(); });

    // Start
    game.start();
  </script>
</Layout>
